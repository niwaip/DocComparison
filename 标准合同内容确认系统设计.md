# 标准合同内容确认系统设计（规则优先 + AI 补充）

## 1. 背景与目标

现有系统的主能力是“左右两份合同的块级对比 + 差异高亮 + 异步 AI 风险分析 + PDF 导出”。在业务上，我们还需要支持“标准合同内容确认”：企业维护多份标准合同（模板），并对某一份实际合同进行逐项确认（确认点是固定且必须存在的），输出一份可追溯、可复核的确认报告。

标准合同内容确认可以被理解为：以“标准合同模板（可为空白/含占位符）”作为左侧，以“实际合同”作为右侧，做对比并在此基础上完成确认点的核验（规则/AI）。

目标：
- 让确认点可配置、可版本化、可批量维护（适配多模板）。
- 规则可覆盖大多数“必填/格式/范围/必须包含/不得更改”类检查。
- AI 用于补充判断与解释、生成建议，不作为唯一决定依据。
- 输出结果必须可溯源到合同原文块（block）与差异行（row）。

非目标（本阶段不强制落地）：
- 不强制引入数据库/权限系统；可先沿用文件化工件管理思路。

## 2. 现有系统复用点（对齐现有实现）

现有对比链路可直接复用：
- 文档解析：doc/pdf 转安全 HTML（services/api/src/lib/docx.ts、pdfInput.ts）
- 分块：HTML → Block[]（services/api/src/lib/blocks.ts）
- 块级对齐：Block[] × Block[] → AlignmentRow[]（services/api/src/lib/align.ts）
- 行内差异：文本 diff → <ins>/<del>（services/api/src/lib/inlineDiff.ts）
- 产物：compare.json / compare.html / compare.pdf（services/api/src/lib/storage.ts）
- 异步：BullMQ + worker（services/api/src/worker.ts）
- AI 分析：按 rows 聚合，生成 overall/section 建议（services/api/src/lib/ai/analyze.ts）

因此，“标准合同确认”最自然的落点，是在 compare.json 的基础上新增一段 confirm 工件，并增加一个新的异步 job（类似 analyze/exportPdf）。

## 3. 关键概念与数据模型（建议）

### 3.1 模板（Standard Template）
每一份标准合同是一份“模板”，需要可版本化：
- templateId：稳定标识（如 std_sales_purchase）
- name：展示名（如《买卖合同（采购）》）
- version：模板版本（如 2026.01）
- sourceFile：原始模板文件（doc/docx/pdf）
- blocksSnapshot：模板 blocks 的快照（用于定位与回溯，避免模板文件变动导致历史任务不可复现）
- metadata：适用范围、业务线、维护人、更新时间等

### 3.2 确认点（Confirmation Point）
确认点是“必须检查的一条要求”，与模板版本强绑定：
- pointId：稳定标识（如 payment.term_days）
- title：确认点标题（如“付款周期不得超过 30 天”）
- description：更详细说明（面向审核人）
- severity：high/medium/low（或业务自定义）
- required：是否强制（通常 true）
- tags：如 付款/违约/责任/交付/争议解决/数据合规
- anchors：如何定位到合同中的证据（下面详述）
- checks：规则检查列表（rule-based）
- aiPolicy：是否/何时需要 AI 复核（ai-based）
- outputPolicy：输出时希望展示的字段、证据摘要格式等

### 3.3 运行实例（Confirmation Run）
一次“模板 + 实际合同”的确认任务：
- runId（可复用 compareId 或单独生成）
- templateRef（templateId + version）
- document（实际合同文件元信息）
- diff（可复用现有 diff 结构：把模板作为 left，把实际合同作为 right）
- confirm：确认结果（规则/AI 的综合输出）

### 3.4 证据锚点（Anchors）——定位的关键
为了让“确认点”能稳定地找到证据，建议支持多种 anchor 策略并可组合：
- byStableKey：使用 Block.stableKey（对模板块最稳；模板版本固定时可作为主键）
- byStructurePath：使用 Block.structurePath（对标题分段结构较稳定时有效）
- bySectionLabel：使用 leading section label（如 1/2/3 或 第X条），配合相似度/窗口搜索
- byKeywordWindow：在 blocks 中按关键词命中，然后在邻域窗口选最相近块
- byDiffRowLink：如果确认点希望只关注“改动”，可限定在 diff.rows 的 modified/inserted/deleted 中定位

证据输出建议包含：
- relatedBlockIds（left/right 各自 blockId）
- relatedRowIds（若能映射到 diff.rows）
- citations（截断后的原文片段，支持脱敏/长度限制）
- extractedValues（从原文提取出的结构化字段，如金额/天数/日期/主体名称等）

## 4. 标准合同确认的总体流程（建议）

1) 选择模板版本 + 上传实际合同  
2) 生成对比工件（模板=left，实际=right），复用现有 compare 流程  
3) 规则预检（Rule Engine）
   - 对每个确认点：定位证据块 → 提取字段 → 执行规则 → 输出 pass/fail/warn/manual
4) AI 补充确认（可选、按策略触发）
   - 仅对“规则无法确定/需要语义判断/风险解释”点调用 AI
5) 生成确认报告
   - overall（摘要、最高风险点、待人工复核点）
   - items（逐确认点：结果、证据、建议、责任人/状态可扩展）
6) 前端展示与导出
   - 报告视图（确认点列表 + 过滤/排序）
   - 点击确认点可跳转到对比视图中的证据块/差异行

## 5. 规则系统设计（Rule-based）

### 5.1 规则优先的原则
- 能用规则确定的，不交给 AI（稳定、可审计、成本低）。
- 规则输出必须结构化、可解释、可追溯到证据文本。
- 规则失败不等于“合同不可用”，而是进入“待复核/不通过/需修订”的工作流状态（状态机可后续扩展）。

### 5.2 建议内置的规则类型（覆盖 80% 需求）
1) presence / mustContain  
   - 必须存在某条款/关键词/标题
2) notModified / mustMatchTemplate  
   - 标准条款不得修改（或只允许白名单变更）
3) extractedNotEmpty  
   - 占位符字段必须填写（如金额、日期、地址、主体名称）
4) regexMatch  
   - 格式校验（发票类型、银行账号、统一社会信用代码等）
5) numberRange / dateRange  
   - 数值/日期范围（如付款周期 ≤ 30 天；交付日期 ≤ 合同签署后 90 天）
6) enumInSet  
   - 枚举值必须在集合内（币种、交付方式等）
7) relationConstraint  
   - 字段间关系（如“预付款比例 + 尾款比例 = 100%”；“违约金上限 ≤ 合同总价的 X%”）
8) crossClauseConsistency  
   - 跨条款一致性（主体名称/地址/签署日期在不同章节一致）

### 5.3 规则输入（提取器 + 校验器）
把“提取”和“校验”拆开，便于维护：
- extractor：从证据块中提取字段（金额/天数/日期/实体名），可配置
- validator：对字段做验证（范围、格式、关系）

提取器建议支持：
- regexCapture（正则捕获）
- keywordAfter（关键词后取值）
- diffInsText（从 diff 的 <ins> 提取新增值，适配“模板空白/占位符 → 实际填写”的场景）
- llmExtract（谨慎使用，仅在规则无法提取时作为 fallback，且要标注置信度与证据）

### 5.4 规则配置的管理形态（结合你们现状）
你们当前已在仓库根目录维护 Excel（RAG_Requirements_legal.xlsx）。建议把“确认点清单”作为第一等资产继续用表格维护，系统提供导入/导出：

推荐列（示例）：
- templateId, templateVersion
- pointId, title, description, severity, required, tags
- anchorType, anchorQuery（如 stableKey/关键词/sectionLabel）
- extractorType, extractorParams
- ruleType, ruleParams
- aiNeeded（never/when_unknown/always）
- owner（维护人）

好处：
- 非研发同学可直接维护确认点与规则参数。
- 可以做版本审阅、变更对比（Excel 也可导出 JSON 入库/入 repo）。

## 6. AI 确认设计（AI-based）

### 6.1 AI 的定位
AI 主要解决三类问题：
- 语义判断：条款是否等价、是否隐藏风险、是否存在“看似合规但实则偏离”的表达。
- 风险解释：把复杂条款差异解释给审核人，并给出可执行建议。
- 规则补全：对“无法结构化”的场景提供“待复核要点”和“追问清单”。

### 6.2 AI 输入输出建议（强 JSON 合同）
建议为“确认点 AI 复核”单独定义 schema（类比现有 analyze.ts 的严格 JSON 输出）：

输入（示例）：
- pointId/title/description/severity/required/tags
- templateClause（模板侧证据文本）
- contractClause（实际合同侧证据文本）
- diffSummary（如有 diff 行）
- ruleResult（规则结果与原因）
- extractedValues（结构化字段）

输出（示例字段）：
- status：pass | fail | warn | manual
- summary：一句话结论
- reasoning：简明依据（不泄露无关内容）
- suggestions：可执行建议列表
- questionsForReview：需要人工确认的问题
- confidence：0-1
- citations：对齐到输入证据片段的引用（不编造）

### 6.3 触发策略（建议默认）
- 若规则 fail：AI 用于解释风险与建议修订（不用于“翻案”）。
- 若规则 unknown/manual：AI 用于给出判断建议与追问。
- 若规则 pass 且条款属于高风险域（付款/责任/争议解决/数据合规）：可抽样 AI 复核（成本可控）。

## 7. 与现有 compare/worker 体系的融合（最小改动路径）

### 7.1 产物扩展建议
在现有 compare.json 中增加：
- standard：模板引用（templateId/version 等）
- confirm：确认任务状态与结果（类似现有 ai/export）

示例结构（概念性）：
- confirm.mode: none | async
- confirm.status: pending | running | done | failed
- confirm.jobId
- confirm.result: { overall, items[] }
- confirm.error

并保留 diff 原样，便于“点击确认点跳到差异证据”。

### 7.2 新增 worker job（概念）
新增 jobName：confirmStandard
- 输入：compareId、templateRef（或已固化在 compare.json）
- worker：读取 compare.json → 执行规则引擎 → 选择性调用 AI → 写回 compare.json
- 失败：写入 confirm.error，方便前端展示与重试

这与现有 analyze/exportPdf 的实现方式一致，能保持系统风格统一。

## 8. 管理与版本化策略（建议优先级）

优先级从易到难：
1) MVP：模板文件 + Excel 规则清单（导入成 JSON 快照写入 compare.json）
2) V1：模板注册表（templateId/version → 文件路径/哈希），确认点规则入库或入 repo JSON
3) V2：引入数据库与权限，支持多人协作、审批流、变更审计、灰度发布

关键原则：
- “模板版本”与“确认点集合版本”必须一致绑定，避免历史报告不可复现。
- 每次 run 都应固化一份“确认点快照”（point definitions snapshot），保证可追溯。

## 9. 常见难点与对策（经验性建议）

1) 模板为空白/占位符导致对齐不稳定  
   - 对策：anchor 首选 stableKey/structurePath；对“字段确认点”走 diffInsText 或关键词定位；必要时在模板里保留提示性关键词（不影响合同文本，但提升定位稳定性）。

2) 跨条款一致性很难纯规则  
   - 对策：先规则提取“主体/地址/日期/金额”等关键字段，再做一致性检查；无法提取时再交给 AI。

3) 条款“改写但语义等价”  
   - 对策：规则层仅做“改动检测 + 白名单”；语义等价交由 AI 做辅助判断，并输出置信度与需复核问题。

4) 证据与输出的可审计性  
   - 对策：所有结论必须附带 citations（原文片段）与 relatedBlockIds/rowIds；AI 输出不得编造引用。

## 10. 建议的落地顺序（可快速见效）

1) 先把“标准合同确认”当成 compare 的一个模式：模板=left、实际=right  
2) 引入“确认点清单”（先用 Excel 管理），把规则引擎跑起来，输出 items 列表  
3) 对少量高风险点接入 AI 复核，形成“规则结论 + AI 解读 + 待复核问题”闭环  
4) 前端增加“确认点视图”，支持跳转到对比证据块/差异行  

